COMPARISON DIFF
============================================================

Original size: 58838 bytes
Chloro size:   54851 bytes
Rustfmt size:  58838 bytes

✗ Outputs DIFFER

=== DIFF (- rustfmt, + chloro) ===
     time::{Duration, Instant},
 };
 
-use crossbeam_channel::{Receiver, never, select};
-use ide_db::base_db::{SourceDatabase, VfsPath, salsa::Database as _};
+use crossbeam_channel::{never, select, Receiver};
+use ide_db::base_db::{salsa::Database as _, SourceDatabase, VfsPath};
 use lsp_server::{Connection, Notification, Request};
-use lsp_types::{TextDocumentIdentifier, notification::Notification as _};
+use lsp_types::{notification::Notification as _, TextDocumentIdentifier};
 use stdx::thread::ThreadIntent;
-use tracing::{Level, error, span};
-use vfs::{AbsPathBuf, FileId, loader::LoadingProgress};
+use tracing::{error, span, Level};
+use vfs::{loader::LoadingProgress, AbsPathBuf, FileId};
 
 use crate::{
     config::Config,
-    diagnostics::{DiagnosticsGeneration, NativeDiagnosticsFetchKind, fetch_native_diagnostics},
+    diagnostics::{fetch_native_diagnostics, DiagnosticsGeneration, NativeDiagnosticsFetchKind},
     discover::{DiscoverArgument, DiscoverCommand, DiscoverProjectMessage},
     flycheck::{self, ClearDiagnosticsKind, ClearScope, FlycheckMessage},
     global_state::{
-        FetchBuildDataResponse, FetchWorkspaceRequest, FetchWorkspaceResponse, GlobalState,
-        file_id_to_url, url_to_file_id,
+        file_id_to_url, url_to_file_id, FetchBuildDataResponse, FetchWorkspaceRequest,
+        FetchWorkspaceResponse, GlobalState,
     },
     handlers::{
-        dispatch::{NotificationDispatcher, RequestDispatcher},
-        request::empty_diagnostic_report,
-    },
-    lsp::{
-        from_proto, to_proto,
-        utils::{Progress, notification_is},
+        dispatch::{NotificationDispatcher, RequestDispatcher}, request::empty_diagnostic_report,
     },
+    lsp::{from_proto, to_proto, utils::{Progress, notification_is}},
     lsp_ext,
     reload::{BuildDataProgress, ProcMacroProgress, ProjectWorkspaceProgress},
     test_runner::{CargoTestMessage, CargoTestOutput, TestState},
     tracing::info!("initial config: {:#?}", config);
 
     // Windows scheduler implements priority boosts: if thread waits for an
+
     // event (like a condvar), and event fires, priority of the thread is
+
     // temporary bumped. This optimization backfires in our case: each time the
+
     // `main_loop` schedules a task to run on a threadpool, the worker threads
+
     // gets a higher priority, and (on a machine with fewer cores) displaces the
+
     // main loop! We work around this by marking the main loop as a
+
     // higher-priority thread.
+
     //
+
     // https://docs.microsoft.com/en-us/windows/win32/procthread/scheduling-priorities
+
     // https://docs.microsoft.com/en-us/windows/win32/procthread/priority-boosts
+
     // https://github.com/rust-lang/rust-analyzer/issues/2835
     #[cfg(windows)]
     unsafe {
 pub(crate) enum PrimeCachesProgress {
     Begin,
     Report(ide::ParallelPrimeCachesProgress),
-    End { cancelled: bool },
+    End {
+        cancelled: bool,
+    },
 }
 
 impl fmt::Debug for Event {
     }
 
     fn register_did_save_capability(&mut self, additional_patterns: impl Iterator<Item = String>) {
-        let additional_filters = additional_patterns.map(|pattern| lsp_types::DocumentFilter {
+        let additional_filters = additional_patterns
+            .map(|pattern| lsp_types::DocumentFilter {
             language: None,
             scheme: None,
             pattern: (Some(pattern)),
             method: "textDocument/didSave".to_owned(),
             register_options: Some(serde_json::to_value(save_registration_options).unwrap()),
         };
-        self.send_request::<lsp_types::request::RegisterCapability>(
+        self
+            .send_request(
             lsp_types::RegistrationParams { registrations: vec![registration] },
             |_, _| (),
         );
         tracing::debug!(%cause, "will prime caches");
         let num_worker_threads = self.config.prime_caches_num_threads();
 
-        self.task_pool.handle.spawn_with_sender(ThreadIntent::Worker, {
+        self.task_pool.handle
+            .spawn_with_sender(ThreadIntent::Worker, {
             let analysis = AssertUnwindSafe(self.snapshot().analysis);
             move |sender| {
                 sender.send(Task::PrimeCaches(PrimeCachesProgress::Begin)).unwrap();
                 let source_root = db.source_root(source_root_id).source_root(db);
                 !source_root.is_library
             })
-            .collect::<Vec<_>>();
+            .collect();
         tracing::trace!("updating tests for {:?}", subscriptions);
 
         // Updating tests are triggered by the user typing
+
         // so we run them on a latency sensitive thread.
-        self.task_pool.handle.spawn(ThreadIntent::LatencySensitive, {
+        self.task_pool.handle
+            .spawn(ThreadIntent::LatencySensitive, {
             let snapshot = self.snapshot();
             move || {
                 let tests = subscriptions
 
     /// Registers and handles a request. This should only be called once per incoming request.
     fn on_new_request(&mut self, request_received: Instant, req: Request) {
-        let _p =
-            span!(Level::INFO, "GlobalState::on_new_request", req.method = ?req.method).entered();
+        let _p = span!(Level::INFO, "GlobalState::on_new_request", req.method = ?req.method).entered();
         self.register_request(&req, request_received);
         self.on_request(req);
     }
     /// Handles a request.
     fn on_request(&mut self, req: Request) {
         let mut dispatcher = RequestDispatcher { req: Some(req), global_state: self };
-        dispatcher.on_sync_mut::<lsp_types::request::Shutdown>(|s, ()| {
+        dispatcher
+            .on_sync_mut(|s, ()| {
             s.shutdown_requested = true;
             Ok(())
         });
         const RETRY: bool = true;
         const NO_RETRY: bool = false;
 
-        #[rustfmt::skip]
         dispatcher
-            // Request handlers that must run on the main thread
-            // because they mutate GlobalState:
-            .on_sync_mut::<lsp_ext::ReloadWorkspace>(handlers::handle_workspace_reload)
-            .on_sync_mut::<lsp_ext::RebuildProcMacros>(handlers::handle_proc_macros_rebuild)
-            .on_sync_mut::<lsp_ext::MemoryUsage>(handlers::handle_memory_usage)
-            .on_sync_mut::<lsp_ext::RunTest>(handlers::handle_run_test)
-            // Request handlers which are related to the user typing
-            // are run on the main thread to reduce latency:
-            .on_sync::<lsp_ext::JoinLines>(handlers::handle_join_lines)
-            .on_sync::<lsp_ext::OnEnter>(handlers::handle_on_enter)
-            .on_sync::<lsp_request::SelectionRangeRequest>(handlers::handle_selection_range)
-            .on_sync::<lsp_ext::MatchingBrace>(handlers::handle_matching_brace)
-            .on_sync::<lsp_ext::OnTypeFormatting>(handlers::handle_on_type_formatting)
-            // Formatting should be done immediately as the editor might wait on it, but we can't
-            // put it on the main thread as we do not want the main thread to block on rustfmt.
-            // So we have an extra thread just for formatting requests to make sure it gets handled
-            // as fast as possible.
-            .on_fmt_thread::<lsp_request::Formatting>(handlers::handle_formatting)
-            .on_fmt_thread::<lsp_request::RangeFormatting>(handlers::handle_range_formatting)
-            // We can’t run latency-sensitive request handlers which do semantic
-            // analysis on the main thread because that would block other
-            // requests. Instead, we run these request handlers on higher priority
-            // threads in the threadpool.
-            // FIXME: Retrying can make the result of this stale?
-            .on_latency_sensitive::<RETRY, lsp_request::Completion>(handlers::handle_completion)
-            // FIXME: Retrying can make the result of this stale
-            .on_latency_sensitive::<RETRY, lsp_request::ResolveCompletionItem>(handlers::handle_completion_resolve)
-            .on_latency_sensitive::<RETRY, lsp_request::SemanticTokensFullRequest>(handlers::handle_semantic_tokens_full)
-            .on_latency_sensitive::<RETRY, lsp_request::SemanticTokensFullDeltaRequest>(handlers::handle_semantic_tokens_full_delta)
-            .on_latency_sensitive::<NO_RETRY, lsp_request::SemanticTokensRangeRequest>(handlers::handle_semantic_tokens_range)
-            // FIXME: Some of these NO_RETRY could be retries if the file they are interested didn't change.
-            // All other request handlers
-            .on_with_vfs_default::<lsp_request::DocumentDiagnosticRequest>(handlers::handle_document_diagnostics, empty_diagnostic_report, || lsp_server::ResponseError {
+            .on_sync_mut(handlers::handle_workspace_reload)
+            .on_sync_mut(handlers::handle_proc_macros_rebuild)
+            .on_sync_mut(handlers::handle_memory_usage)
+            .on_sync_mut(handlers::handle_run_test)
+            .on_sync(handlers::handle_join_lines)
+            .on_sync(handlers::handle_on_enter)
+            .on_sync(handlers::handle_selection_range)
+            .on_sync(handlers::handle_matching_brace)
+            .on_sync(handlers::handle_on_type_formatting)
+            .on_fmt_thread(handlers::handle_formatting)
+            .on_fmt_thread(handlers::handle_range_formatting)
+            .on_latency_sensitive(handlers::handle_completion)
+            .on_latency_sensitive(handlers::handle_completion_resolve)
+            .on_latency_sensitive(handlers::handle_semantic_tokens_full)
+            .on_latency_sensitive(handlers::handle_semantic_tokens_full_delta)
+            .on_latency_sensitive(handlers::handle_semantic_tokens_range)
+            .on_with_vfs_default(handlers::handle_document_diagnostics, empty_diagnostic_report, || lsp_server::ResponseError {
                 code: lsp_server::ErrorCode::ServerCancelled as i32,
                 message: "server cancelled the request".to_owned(),
                 data: serde_json::to_value(lsp_types::DiagnosticServerCancellationData {
                     retrigger_request: true
                 }).ok(),
             })
-            .on::<RETRY, lsp_request::DocumentSymbolRequest>(handlers::handle_document_symbol)
-            .on::<RETRY, lsp_request::FoldingRangeRequest>(handlers::handle_folding_range)
-            .on::<NO_RETRY, lsp_request::SignatureHelpRequest>(handlers::handle_signature_help)
-            .on::<RETRY, lsp_request::WillRenameFiles>(handlers::handle_will_rename_files)
-            .on::<NO_RETRY, lsp_request::GotoDefinition>(handlers::handle_goto_definition)
-            .on::<NO_RETRY, lsp_request::GotoDeclaration>(handlers::handle_goto_declaration)
-            .on::<NO_RETRY, lsp_request::GotoImplementation>(handlers::handle_goto_implementation)
-            .on::<NO_RETRY, lsp_request::GotoTypeDefinition>(handlers::handle_goto_type_definition)
-            .on::<NO_RETRY, lsp_request::InlayHintRequest>(handlers::handle_inlay_hints)
-            .on_identity::<NO_RETRY, lsp_request::InlayHintResolveRequest, _>(handlers::handle_inlay_hints_resolve)
-            .on::<NO_RETRY, lsp_request::CodeLensRequest>(handlers::handle_code_lens)
-            .on_identity::<NO_RETRY, lsp_request::CodeLensResolve, _>(handlers::handle_code_lens_resolve)
-            .on::<NO_RETRY, lsp_request::PrepareRenameRequest>(handlers::handle_prepare_rename)
-            .on::<NO_RETRY, lsp_request::Rename>(handlers::handle_rename)
-            .on::<NO_RETRY, lsp_request::References>(handlers::handle_references)
-            .on::<NO_RETRY, lsp_request::DocumentHighlightRequest>(handlers::handle_document_highlight)
-            .on::<NO_RETRY, lsp_request::CallHierarchyPrepare>(handlers::handle_call_hierarchy_prepare)
-            .on::<NO_RETRY, lsp_request::CallHierarchyIncomingCalls>(handlers::handle_call_hierarchy_incoming)
-            .on::<NO_RETRY, lsp_request::CallHierarchyOutgoingCalls>(handlers::handle_call_hierarchy_outgoing)
-            // All other request handlers (lsp extension)
-            .on::<RETRY, lsp_ext::FetchDependencyList>(handlers::fetch_dependency_list)
-            .on::<RETRY, lsp_ext::AnalyzerStatus>(handlers::handle_analyzer_status)
-            .on::<RETRY, lsp_ext::ViewFileText>(handlers::handle_view_file_text)
-            .on::<RETRY, lsp_ext::ViewCrateGraph>(handlers::handle_view_crate_graph)
-            .on::<RETRY, lsp_ext::ViewItemTree>(handlers::handle_view_item_tree)
-            .on::<RETRY, lsp_ext::DiscoverTest>(handlers::handle_discover_test)
-            .on::<RETRY, lsp_ext::WorkspaceSymbol>(handlers::handle_workspace_symbol)
-            .on::<NO_RETRY, lsp_ext::Ssr>(handlers::handle_ssr)
-            .on::<NO_RETRY, lsp_ext::ViewRecursiveMemoryLayout>(handlers::handle_view_recursive_memory_layout)
-            .on::<NO_RETRY, lsp_ext::ViewSyntaxTree>(handlers::handle_view_syntax_tree)
-            .on::<NO_RETRY, lsp_ext::ViewHir>(handlers::handle_view_hir)
-            .on::<NO_RETRY, lsp_ext::ViewMir>(handlers::handle_view_mir)
-            .on::<NO_RETRY, lsp_ext::InterpretFunction>(handlers::handle_interpret_function)
-            .on::<NO_RETRY, lsp_ext::ExpandMacro>(handlers::handle_expand_macro)
-            .on::<NO_RETRY, lsp_ext::ParentModule>(handlers::handle_parent_module)
-            .on::<NO_RETRY, lsp_ext::ChildModules>(handlers::handle_child_modules)
-            .on::<NO_RETRY, lsp_ext::Runnables>(handlers::handle_runnables)
-            .on::<NO_RETRY, lsp_ext::RelatedTests>(handlers::handle_related_tests)
-            .on::<NO_RETRY, lsp_ext::CodeActionRequest>(handlers::handle_code_action)
-            .on_identity::<RETRY, lsp_ext::CodeActionResolveRequest, _>(handlers::handle_code_action_resolve)
-            .on::<NO_RETRY, lsp_ext::HoverRequest>(handlers::handle_hover)
-            .on::<NO_RETRY, lsp_ext::ExternalDocs>(handlers::handle_open_docs)
-            .on::<NO_RETRY, lsp_ext::OpenCargoToml>(handlers::handle_open_cargo_toml)
-            .on::<NO_RETRY, lsp_ext::MoveItem>(handlers::handle_move_item)
-            //
-            .on::<NO_RETRY, lsp_ext::InternalTestingFetchConfig>(handlers::internal_testing_fetch_config)
+            .on(handlers::handle_document_symbol)
+            .on(handlers::handle_folding_range)
+            .on(handlers::handle_signature_help)
+            .on(handlers::handle_will_rename_files)
+            .on(handlers::handle_goto_definition)
+            .on(handlers::handle_goto_declaration)
+            .on(handlers::handle_goto_implementation)
+            .on(handlers::handle_goto_type_definition)
+            .on(handlers::handle_inlay_hints)
+            .on_identity(handlers::handle_inlay_hints_resolve)
+            .on(handlers::handle_code_lens)
+            .on_identity(handlers::handle_code_lens_resolve)
+            .on(handlers::handle_prepare_rename)
+            .on(handlers::handle_rename)
+            .on(handlers::handle_references)
+            .on(handlers::handle_document_highlight)
+            .on(handlers::handle_call_hierarchy_prepare)
+            .on(handlers::handle_call_hierarchy_incoming)
+            .on(handlers::handle_call_hierarchy_outgoing)
+            .on(handlers::fetch_dependency_list)
+            .on(handlers::handle_analyzer_status)
+            .on(handlers::handle_view_file_text)
+            .on(handlers::handle_view_crate_graph)
+            .on(handlers::handle_view_item_tree)
+            .on(handlers::handle_discover_test)
+            .on(handlers::handle_workspace_symbol)
+            .on(handlers::handle_ssr)
+            .on(handlers::handle_view_recursive_memory_layout)
+            .on(handlers::handle_view_syntax_tree)
+            .on(handlers::handle_view_hir)
+            .on(handlers::handle_view_mir)
+            .on(handlers::handle_interpret_function)
+            .on(handlers::handle_expand_macro)
+            .on(handlers::handle_parent_module)
+            .on(handlers::handle_child_modules)
+            .on(handlers::handle_runnables)
+            .on(handlers::handle_related_tests)
+            .on(handlers::handle_code_action)
+            .on_identity(handlers::handle_code_action_resolve)
+            .on(handlers::handle_hover)
+            .on(handlers::handle_open_docs)
+            .on(handlers::handle_open_cargo_toml)
+            .on(handlers::handle_move_item)
+            .on(handlers::internal_testing_fetch_config)
             .finish();
     }
 
     /// Handles an incoming notification.
     fn on_notification(&mut self, not: Notification) {
-        let _p =
-            span!(Level::INFO, "GlobalState::on_notification", not.method = ?not.method).entered();
+        let _p = span!(Level::INFO, "GlobalState::on_notification", not.method = ?not.method).entered();
         use crate::handlers::notification as handlers;
         use lsp_types::notification as notifs;
 
         NotificationDispatcher { not: Some(not), global_state: self }
-            .on_sync_mut::<notifs::Cancel>(handlers::handle_cancel)
-            .on_sync_mut::<notifs::WorkDoneProgressCancel>(
+            .on_sync_mut(handlers::handle_cancel)
+            .on_sync_mut(
                 handlers::handle_work_done_progress_cancel,
             )
-            .on_sync_mut::<notifs::DidOpenTextDocument>(handlers::handle_did_open_text_document)
-            .on_sync_mut::<notifs::DidChangeTextDocument>(handlers::handle_did_change_text_document)
-            .on_sync_mut::<notifs::DidCloseTextDocument>(handlers::handle_did_close_text_document)
-            .on_sync_mut::<notifs::DidSaveTextDocument>(handlers::handle_did_save_text_document)
-            .on_sync_mut::<notifs::DidChangeConfiguration>(
+            .on_sync_mut(handlers::handle_did_open_text_document)
+            .on_sync_mut(handlers::handle_did_change_text_document)
+            .on_sync_mut(handlers::handle_did_close_text_document)
+            .on_sync_mut(handlers::handle_did_save_text_document)
+            .on_sync_mut(
                 handlers::handle_did_change_configuration,
             )
-            .on_sync_mut::<notifs::DidChangeWorkspaceFolders>(
+            .on_sync_mut(
                 handlers::handle_did_change_workspace_folders,
             )
-            .on_sync_mut::<notifs::DidChangeWatchedFiles>(handlers::handle_did_change_watched_files)
-            .on_sync_mut::<lsp_ext::CancelFlycheck>(handlers::handle_cancel_flycheck)
-            .on_sync_mut::<lsp_ext::ClearFlycheck>(handlers::handle_clear_flycheck)
-            .on_sync_mut::<lsp_ext::RunFlycheck>(handlers::handle_run_flycheck)
-            .on_sync_mut::<lsp_ext::AbortRunTest>(handlers::handle_abort_run_test)
+            .on_sync_mut(handlers::handle_did_change_watched_files)
+            .on_sync_mut(handlers::handle_cancel_flycheck)
+            .on_sync_mut(handlers::handle_clear_flycheck)
+            .on_sync_mut(handlers::handle_run_flycheck)
+            .on_sync_mut(handlers::handle_abort_run_test)
             .finish();
     }
 }